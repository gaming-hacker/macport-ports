# -*- coding: utf-8; mode: _tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- vim:fenc=utf-8:filetype=tcl:et:sw=2:ts=2:sts=2

PortSystem                  1.0

name                        pinentry
version                     1.1.1
revision                    0
categories                  security
license                     GPL-2+
maintainers                 {ionic @Ionic} openmaintainer
homepage                    https://gnupg.org/software/pinentry/
platforms                   darwin
master_sites                gnupg

description                 Passphrase entry dialog utilizing the Assuan protocol

long_description            This is a collection of simple PIN or passphrase entry \
                            dialogs in a secure manner.

use_bzip2                   yes

checksums  rmd160  1b1a42245564b57c0fc0695d1c3c2d68e1cbf3ba \
sha256  cd12a064013ed18e2ee8475e669b9f58db1b225a0144debdb85a68cecddba57f \
size    515723

configure.args              --with-libiconv-prefix=${prefix} \
                            --with-ncurses-include-dir=${prefix}/include/ncurses \
                            --enable-pinentry-curses \
                            --disable-pinentry-gtk2 \
                            --disable-pinentry-gnome3 \
                            --disable-libsecret \
                            --disable-pinentry-tqt \
                            --disable-pinentry-qt \
                            --disable-pinentry-qt5 \
                            --disable-pinentry-fltk

configure.cflags-append     -DNCURSES_WIDECHAR=1

# Fix picking up the correct assuan version.
# -isystem has the added benefit of moving the include
# directory specified to the end of the include path list.
# This will help the build system respect custom include
# paths correctly (i.e., searching them before the MP include
# directory.)
configure.cppflags-replace  -I${prefix}/include -isystem${prefix}/include

depends_build               port:pkgconfig
depends_lib                 port:libiconv \
                            port:ncurses \
                            port:libassuan \
                            port:libgpg-error

variant gtk2 description {Enable gtk2-based pinentry tool} {
    depends_lib-append      port:gtk2
    configure.args-delete   --disable-pinentry-gtk2
    configure.args-append   --enable-pinentry-gtk2 \
                            --enable-fallback-curses
}

variant gnome3 description {Enable GNOME3/gtk3-based pinentry tool} {
    depends_lib-append      port:gcr \
                            port:libsecret
    configure.args-delete   --disable-pinentry-gnome3 \
                            --disable-libsecret
    configure.args-append   --enable-pinentry-gnome3 \
                            --enable-fallback-curses \
                            --enable-libsecret
}

#variant tqt conflicts qt5 qt4 description {Enable tqt-based pinentry tool} {
#    PortGroup               tqt 1.0
#    configure.args-delete   --disable-pinentry-tqt
#    configure.args-append   --enable-pinentry-tqt \
#                            --enable-fallback-curses
#}

variant qt5 conflicts qt4 description {Enable qt5-based pinentry tool} {
    PortGroup               qt5 1.0

    # FIXME: why do we have a qt5 PortGroup if it doesn't set PATH correctly?!
    configure.env-append    MOC=${qt_moc_cmd}

    configure.args-delete   --disable-pinentry-qt \
                            --disable-pinentry-qt5
    configure.args-append   --enable-pinentry-qt \
                            --enable-pinentry-qt5 \
                            --enable-fallback-curses
}

variant fltk description {Enable FLTK-based pinentry tool} {
    # fltk-devel is currently unsupported, only version 1.3.x.
    depends_lib-append      port:fltk

    configure.args-replace  --disable-pinentry-fltk \
                            --enable-pinentry-fltk
}

livecheck.type              regex
livecheck.url               https://gnupg.org/ftp/gcrypt/pinentry/
livecheck.regex             ${name}-(\\d+\\.\\d+\\.\\d+)
