# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0

name            cups-ppdc
version         1.6.2
categories      print textproc
license         GPL-2
maintainers     nomaintainer
description     Compiler for PostScript Printer Description (PPD) files
long_description \
    cups-ppdc is a collection of utilities taken from the Common UNIX Printing System (CUPS) \
    for working with PostScript Printer Description (PPD) files\; \
    PPD files can be used to set up a printer when proprietary drivers are not available. \
    These utilities (ppdc, ppdi, ppdmerge, ppdhtml, and ppdpo) are present on Mac OS X 10.6 and later\; \
    this package includes the versions that shipped with Mac OS X 10.8. \
    See the ppdcfile(5) man page for information on the PPD file format.

homepage        https://opensource.apple.com/source/cups

distname        cups-327.7
master_sites    https://opensource.apple.com/tarballs/cups
checksums       rmd160  5d99a2fe54182993956a17e813b73c583478d2d1 \
                sha256  6106bab36b25ad45c03575da1a900133cc69e18eb41db15a366d8f8a930b97bb \
                size    8979707

patchfiles      patch-static-targets.diff

worksrcdir  ${worksrcdir}/cups

post-patch {
    # Fix broken build with old GCC and unrecognized flag warnings with new GCC
    reinplace "s|@PIEFLAGS@||" Makedefs.in
}

if {[string match *gcc* ${configure.compiler}] && ![string match *gcc-\[4-6\]* ${configure.compiler}]} {
    configure.cflags-append     -Wno-format-truncation
    configure.cxxflags-append     -Wno-format-truncation
}

configure.args-append   --disable-dnssd
configure.args-append   --disable-gssapi
configure.args-append   --disable-ssl
configure.args-append   --disable-shared
configure.args-append   --with-bundledir=""
configure.cflags-append -fno-stack-protector
configure.cxxflags-append -fno-stack-protector
if {${os.platform} eq "darwin" && ${os.major} < 10} {
    configure.cflags-append -U__BLOCKS__
    configure.cxxflags-append -U__BLOCKS__
}

post-configure {
    platform darwin 8 {
        # res_init() symbol is found, but the prototype is never included due
        # to broken resolv.h on Tiger. Don't need networking so just tell the
        # build we've never heard of res_init().
        reinplace "s|#define HAVE_RES_INIT 1|/* #undef HAVE_RES_INIT */|" config.h
    }
}

build {
    exec -ignorestderr make -C ${worksrcpath}/cups
    foreach tool {ppdc ppdi ppdpo ppdhtml ppdmerge} {
        exec -ignorestderr make -C ${worksrcpath}/ppdc ${tool}-static
    }
    foreach tool {ppdc ppdi ppdpo ppdhtml ppdmerge} {
        exec make -C ${worksrcpath}/man ${tool}.1.gz 2>@1
    }
    exec make -C ${worksrcpath}/man ppdcfile.5.gz 2>@1
}

destroot {
    xinstall -d ${destroot}${prefix}/share/cups/ppdc

    xinstall -m 644 -W ${worksrcpath}/data \
        font.defs media.defs raster.defs \
        epson.h hp.h label.h \
        ${destroot}${prefix}/share/cups/ppdc

    foreach tool {ppdc ppdi ppdpo ppdhtml ppdmerge} {
        xinstall -m 755 ${worksrcpath}/ppdc/${tool}-static \
            ${destroot}${prefix}/bin
        file rename ${destroot}${prefix}/bin/${tool}-static \
            ${destroot}${prefix}/bin/${tool}
    }

    foreach tool {ppdc ppdi ppdpo ppdhtml ppdmerge} {
        xinstall -m 644 ${worksrcpath}/man/${tool}.1.gz \
            ${destroot}${prefix}/share/man/man1
    }
    xinstall -m 644 ${worksrcpath}/man/ppdcfile.5.gz \
        ${destroot}${prefix}/share/man/man5
}
