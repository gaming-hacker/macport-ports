# -*- coding: utf-8; mode: _tcl; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- vim:fenc=utf-8:ft=tcl:et:sw=2:ts=2:sts=2

PortSystem          1.0
PortGroup           qmake5 1.0
PortGroup           github 1.0

qt5.depends_component qtdeclarative qtquickcontrols2

name                yubico-authenticator
github.setup        Yubico yubioath-desktop 5.0.5 yubioath-desktop-
revision            0
categories          aqua security
platforms           darwin
license             BSD
maintainers         {amake @amake} openmaintainer

description         Tool for generating one-time password codes with YubiKey
long_description \
    Cross-platform application for generating Open Authentication (OATH) \
    time-based TOTP and event-based HOTP one-time password codes, with the help \
    of a YubiKey that protects the shared secrets.

homepage            https://developers.yubico.com/yubioath-desktop/

checksums           rmd160  d0eb25dd8ce4902fbf4f31bb5a6a99a84fa3c486 \
sha256  88561ebaf328c1ff501ffe5c0690208226f32f82f35093bd3ff5b26980e311fb \
size    5659118

# Python version must be synced with pyotherside and yubikey-manager ports
set python.branch   3.9
set python.version  [join [split ${python.branch} "."] ""]
set python.prefix   ${frameworks_dir}/Python.framework/Versions/${python.branch}
set python.pkgd     ${python.prefix}/lib/python${python.branch}/site-packages
set python.bin      ${python.prefix}/bin/python${python.branch}

depends_lib-append  port:pyotherside

depends_run-append  port:yubikey-manager

qt5.min_version     5.7

patchfiles          0001-Remove-pip-installation-for-packaging-in-MacPorts.patch
patch.pre_args      -p1

post-patch {
    reinplace "s|PYTHON_CMD = python3|PYTHON_CMD = ${python.bin}|" \
        ${worksrcpath}/yubioath-desktop.pro
}

destroot {
    # Install bundled Python code
    xinstall -d ${destroot}/${python.pkgd}
    copy {*}[glob ${worksrcpath}/py/*] ${destroot}${python.pkgd}/

    # Bundled Python is now a symlink to global site-packages
    ln -s ${python.pkgd} ${worksrcpath}/yubioath-desktop.app/Contents/MacOS/pymodules

    # The default install task insists on putting it in $(INSTALL_ROOT)/usr/bin
    # so we do our own thing here.
    system -W ${worksrcpath}/yubioath-desktop.app \
           "strip Contents/MacOS/yubioath-desktop"
    copy ${worksrcpath}/yubioath-desktop.app "${destroot}/${applications_dir}/Yubico Authenticator.app"
}

github.livecheck.regex  {([0-9.]+)}
